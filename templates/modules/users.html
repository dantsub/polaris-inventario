{% extends 'base.html' %} {% block title %} Usuarios {% endblock title %} {%
block content %} {% if error %}
<script>
  (function abrirmodal() {
    $(function () {
      // abrir modal
      $("#modal_crear").modal("show");
    });
  })();
</script>
{% endif %}
<main class="card">
  <div class="card-body border-bottom">
    <h2>Usuarios</h2>
    <!-- Filtros -->
    <div class="row gap-row-5">
      <div class="col-sm-12 col-md-6">
        <label class="form-label" for="searchUsuario"></label>
        <input
          type="search"
          class="form-control w-50"
          placeholder="Buscar"
          id="searchUsuario"
        />
      </div>
      <div
        class="col-sm-12 col-md-6 d-flex align-items-center justify-content-end"
      >
        <label class="form-label mr-1" for="">Crear usuario</label>
        <button
          class="btn btn-primary"
          id="crear"
          data-toggle="modal"
          data-target="#modal_crear"
        >
          <span class="fa fa-user-plus"></span>
        </button>
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages() %} {% if messages %} {% for message
    in messages %}
    <div class="alert alert-warning text-center alert-dismissible fade show" role="alert">
      <strong>{{ message }}</strong>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    {% endfor %} {% endif %} {% endwith %}
       
  <!-- Lista de usuarios -->
  <div class="card-dataTable table-responsive" style="padding: 5px">
    <table class="table table-bordered table-hover">
      <thead>
        <tr>
          <th>Nombre usuario</th>
          <th>Nombres</th>
          <th>Apellidos</th>
          <th>Cedula</th>
          <th>Correo</th>
          <th>Rol</th>
          <th>Fecha creación</th>
          <th>Fecha de vencimiento</th>
          <th class="col-sticky">Acciones</th>
        </tr>
      </thead>
      <tbody id="tablausuario" class="js-table-body">
        {% for usuario in usuarios %} {% if usuario.6 %}
        <tr class="table-danger">
          {% else %}
        </tr>

        <tr>
          {% endif %}
          <td>{{usuario.0}}</td>
          <td>{{usuario.1}}</td>
          <td>{{usuario.2}}</td>
          <td>{{usuario.3}}</td>
          <td>{{usuario.4}}</td>
          <td>{{usuario.7}}</td>
          <td>{{usuario.5}}</td>
          <td>{{usuario.6}}</td>
          {% if usuario.6 %}
          <td class="py-1 px-2" text-align="center">{% else %}</td>

          <td class="py-1 px-2 col-sticky js-sticky d-flex" text-align="center">
            {% endif %} {% if usuario.6 == None %}
            <button
              class="btn btn-primary table-buttons"
              id="editar"
              data-bs-toggle="modal"
              data-bs-target="#modal_editar-{{usuario.0}}"
            >
              <span class="fas fa-edit"></span>
            </button>
            <div
              class="modal fade"
              id="modal_editar-{{usuario.0}}"
              tabindex="-1"
              role="dialog"
              aria-labelledby="titulo_crear"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="titulo_crear">
                      Editar Usuario
                    </h5>
                    <button
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="close"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <form
                      action="{{url_for('users')}}"
                      class="row g-3 needs-validation"
                      method="POST"
                      novalidate
                    >
                      <div class="form-group">
                        <label for="id">Nombre de usuario*</label>
                        <input
                          type="text"
                          class="form-control"
                          placeholder="Nombre de usuario"
                          required
                          value="{{usuario.0}}"
                          disabled
                          disabled
                        />
                        <input type="hidden" name="oculto" value="editar" />
                        <input
                          type="hidden"
                          name="ocultoeditar"
                          value="{{usuario.0}}"
                        />

                        <div class="invalid-feedback">
                          Por favor ingrese el nombre de usuario.
                        </div>

                        <label for="nombres">Nombres*</label>
                        <input
                          type="text"
                          class="form-control"
                          placeholder="Ingrese los nombres"
                          required
                          name="nombres2"
                          value="{{usuario.1}}"
                        />

                        <div class="invalid-feedback">
                          Por favor ingrese los nombres.
                        </div>

                        <label for="apellidos">Apellidos*</label>
                        <input
                          type="text"
                          class="form-control"
                          placeholder="Ingrese los apellidos"
                          required
                          name="apellidos2"
                          value="{{usuario.2}}"
                        />
                        <div class="invalid-feedback">
                          Por favor ingrese los apellidos.
                        </div>

                        <label for="cedula">Documento*</label>
                        <input
                          type="number"
                          class="form-control"
                          placeholder="Ingrese el número del documento"
                          required
                          number
                          name="cedula2"
                          value="{{usuario.3}}"
                        />
                        <div class="invalid-feedback">
                          Por favor ingrese un número de documento solo de
                          números.
                        </div>

                        <label for="correo">Correo*</label>
                        <input
                          type="email"
                          class="form-control"
                          placeholder="Ingrese el correo electrónico"
                          required
                          email
                          name="correo2"
                          value="{{usuario.4}}"
                        />
                        <div class="invalid-feedback">
                          Por favor ingrese un correo electrónico valido.
                        </div>

                        <label for="rol_crear" class="form-label">Rol*</label>
                        <select
                          class="form-select"
                          required
                          name="rol_crear2"
                          value="{{usuario.8}}"
                        >
                          <option value="3">Usuario final</option>
                          {% if session.rol == "SuperAdministrador" %}
                          <option class="select-editar-admin" value="2">
                            Administrador
                          </option>
                          <option class="select-editar-super" value="1">
                            Super Administrador
                          </option>
                          {% endif %}
                        </select>
                        <div class="invalid-feedback">
                          Por favor ingrese el rol.
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button
                          type="button"
                          class="btn btn-secondary"
                          data-bs-dismiss="modal"
                        >
                          Cancelar
                        </button>
                        <button class="btn btn-primary" type="submit">
                          Editar usuario
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <!-- Final modal editar -->
            &nbsp;
            <button
              href="{{usuario.0}}"
              class="btn btn-danger table-buttons"
              data-bs-toggle="modal"
              data-bs-target="#modal_eliminar-{{usuario.0}}"
            >
              <i class="fa fa-trash"></i>
            </button>
            <!-- Modal eliminar -->
            <div
              class="modal fade"
              id="modal_eliminar-{{usuario.0}}"
              tabindex="-1"
              role="dialog"
              aria-labelledby="titulo_eliminar"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 id="titulo_eliminar">Eliminar Usuario</h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <form
                      action="{{url_for('users')}}"
                      class="form_eliminar row g-3 needs-validation"
                      method="POST"
                      novalidate
                    >
                      <input type="hidden" name="oculto" value="eliminar" />
                      <input
                        type="hidden"
                        name="ocultoborrar"
                        value="{{usuario.0}}"
                      />
                      <p class="text-center">
                        ¿Está seguro que desea eliminar el usuario?
                      </p>
                      <div class="modal-footer">
                        <button
                          type="button"
                          class="btn btn-secondary"
                          data-bs-dismiss="modal"
                        >
                          Cancelar
                        </button>
                        <button class="btn btn-primary" type="submit" name="si">
                          Eliminar usuario
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <!-- Final modal eliminar -->
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <!-- Modal crear usuario -->

  <div
    class="modal fade"
    id="modal_crear"
    nombre="modal_crear"
    tabindex="-1"
    role="dialog"
    aria-labelledby="titulo_crear"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="titulo_crear">Crear Usuario</h5>
          <button
            type="button"
            class="btn-close"
            data-dismiss="modal"
            aria-label="Cerrar"
          ></button>
        </div>
        <div class="modal-body">
          <form
            id="form_crear"
            action="{{url_for('users')}}"
            class="row g-3 needs-validation"
            method="POST"
            novalidate
          >
            <div class="form-group">
              <input type="hidden" name="oculto" value="crear" />

              <label class="form-label" for="usuario">Nombre de usuario*</label>
              <input
                type="text"
                class="form-control"
                id="usuario"
                name="usuario"
                placeholder="Nombre de usuario"
                required
              />
              <div class="invalid-feedback">
                Por favor ingrese el nombre de usuario.
              </div>

              <div id="errorusuario" style="color: red">
                {% if data1 %} {{data1}} {% endif %}
              </div>

              <label for="nombres">Nombres*</label>
              <input
                type="text"
                class="form-control"
                id="nombres"
                name="nombres"
                placeholder="Ingrese los nombres"
                required
              />
              <div class="invalid-feedback">Por favor ingrese los nombres.</div>
              <div id="errornombre" style="color: red">
                {% if data2 %} {{data2}} {% endif %}
              </div>

              <label for="apellidos">Apellidos*</label>
              <input
                type="text"
                class="form-control"
                id="apellidos"
                name="apellidos"
                placeholder="Ingrese los apellidos"
                required
              />
              <div class="invalid-feedback">
                Por favor ingrese los apellidos.
              </div>
              <div id="errorapellido" style="color: red">
                {% if data3 %} {{data3}} {% endif %}
              </div>

              <label for="cedula">Documento*</label>
              <input
                type="number"
                class="form-control"
                id="cedula"
                name="cedula"
                placeholder="Ingrese el número del documento"
                required
                number
              />
              <div class="invalid-feedback">
                Por favor ingrese el número de documento.
              </div>
              <div id="errordocumento" style="color: red">
                {% if data4 %} {{data4}} {% endif %}
              </div>

              <label for="correo">Correo*</label>
              <input
                type="email"
                class="form-control"
                id="correo"
                name="correo"
                placeholder="Ingrese el correo electrónico"
                required
                email
              />
              <div class="invalid-feedback">
                Por favor ingrese un correo electrónico valido.
              </div>
              <div id="errorcorreo" style="color: red">
                {% if data5 %} {{data5}} {% endif %}
              </div>

              <label for="rol_crear" class="form-label">Rol*</label>
              <select
                class="form-select"
                id="rol_crear"
                name="rol_crear"
                required
              >
                <option value="3">Usuario final</option>
                {% if session.rol == "SuperAdministrador" %}
                <option class="select-crear-admin" value="2">
                  Administrador
                </option>
                <option class="select-crear-super" value="1">
                  Super Administrador
                </option>
                {% endif %}
              </select>
              <div class="invalid-feedback">Por favor ingrese el rol.</div>
              <div id="errorrol" style="color: red">
                {% if data6 %} {{data6}} {% endif %}
              </div>

              <label for="passw">Contraseña*</label>
              <input
                type="password"
                class="form-control"
                id="passw"
                name="passw"
                placeholder="Ingrese la contraseña"
                required
                minlength="6"
              />
              <div class="invalid-feedback">
                Por favor ingrese una contraseña valida de mínimo 6 caracteres.
              </div>
              <div id="errorclave" style="color: red">
                {% if data7 %} {{data7}} {% endif %}
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" type="submit">Crear</button>
            </div>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          </form>
          {% if error %}
          <script type="text/javascript">
            $("#usuario").val("{{usuario}}");
            $("#nombres").val("{{nombre}}");
            $("#apellidos").val("{{apellido}}");
            $("#cedula").val("{{documento}}");
            $("#correo").val("{{correo}}");
            $("#rol_crear").val("{{rol}}");
          </script>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    (function modalInBody() {
      $(function () {
        $("#modal_crear").appendTo("body")
      });
    })();
  </script>

</main>

<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-kQtW33rZJAHjgefvhyyzcGF3C5TFyBQBA13V1RKPf4uH+bwyzQxZ6CmMZHmNBEfJ"
  crossorigin="anonymous"
></script>

<script src="{{ url_for('static', filename='js/validacionCrearUsuario.js') }}"></script>
<script>
  $("#modal_crear").on("show.bs.modal", function (event) {
    $("#form_crear").trigger("reset");
  });
</script>

{% endblock content %}
